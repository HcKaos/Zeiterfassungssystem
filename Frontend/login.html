<!DOCTYPE html>
<!--
/**
 * Login & Registration Page
 * 
 * This page provides the authentication interface for the time tracking system.
 * Features dual-tab design for both login and user registration functionality.
 * 
 * Security Features:
 * - Client-side password validation
 * - Password confirmation matching
 * - Session-based authentication
 * - CSRF protection via fetch credentials
 * 
 * UX Features:
 * - Responsive Bootstrap design
 * - Tab-based interface switching
 * - Real-time form validation
 * - Error message display
 * 
 * @author Dan
 * @version 1.0.0
 */
-->
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Registrierung - Zeiterfassungssystem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <img src="images/logo-placeholder.svg" class="logo-img" alt="Logo">
                        </div>

                        <ul class="nav nav-tabs nav-fill mb-3" id="authTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab" aria-controls="login-pane" aria-selected="true">Login</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane" type="button" role="tab" aria-controls="register-pane" aria-selected="false">Registrierung</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="authTabsContent">
                            <div class="tab-pane fade show active" id="login-pane" role="tabpanel" aria-labelledby="login-tab">
                                <h3 class="card-title text-center mb-4">Login</h3>
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="loginEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">Passwort</label>
                                        <input type="password" class="form-control" id="loginPassword" required>
                                    </div>
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary">Login</button>
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="register-pane" role="tabpanel" aria-labelledby="register-tab">
                                <h3 class="card-title text-center mb-4">Registrierung</h3>
                                <form id="registerForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="registerVorname" class="form-label">Vorname</label>
                                            <input type="text" class="form-control" id="registerVorname" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="registerNachname" class="form-label">Nachname</label>
                                            <input type="text" class="form-control" id="registerNachname" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="registerEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerPassword" class="form-label">Passwort</label>
                                        <input type="password" class="form-control" id="registerPassword" required minlength="8">
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerPasswordConfirm" class="form-label">Passwort bestätigen</label>
                                        <input type="password" class="form-control" id="registerPasswordConfirm" required minlength="8">
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerAdresse" class="form-label">Adresse</label>
                                        <input type="text" class="form-control" id="registerAdresse">
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerTelefonnummer" class="form-label">Telefonnummer</label>
                                        <input type="tel" class="form-control" id="registerTelefonnummer">
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerBildungstraeger" class="form-label">Bildungsträger und Standort</label>
                                        <input type="text" class="form-control" id="registerBildungstraeger" placeholder="z.B: Bildungsträger Köln, Bildungsträger München, ...">
                                    </div>
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-success">Registrieren</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ================================ -->
    <!-- AUTHENTICATION JAVASCRIPT       -->
    <!-- ================================ -->
    <script>
    /**
     * Authentication handling for login and registration
     * 
     * This script manages:
     * - Login form submission and validation
     * - Registration form submission with password confirmation
     * - Session-based authentication via API calls
     * - Error handling and user feedback
     * - Automatic redirect after successful authentication
     */
    document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");

        if(loginForm) {
            loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const email = document.getElementById("loginEmail").value; // Changed from loginBenutzername
            const password = document.getElementById("loginPassword").value;

            try {
                const response = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        email, // Changed from benutzername
                        passwort: password
                    }),
                    credentials: "include"
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem("userRole", data.rolle);

                    if (data.rolle === "Betreuer") {
                        window.location.href = "/admindashboard.html";
                    } else {
                        window.location.href = "/dashboard.html";
                    }
                } else {
                    alert(data.message || "Login fehlgeschlagen");
                }
            } catch (error) {
                console.error("Login Fehler:", error);
                alert("Login fehlgeschlagen. Bitte versuchen Sie es später erneut.");
            }
        });
        }

        if(registerForm) {
            registerForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                const vorname = document.getElementById("registerVorname").value;
                const nachname = document.getElementById("registerNachname").value;
                const email = document.getElementById("registerEmail").value; // Added email
                const password = document.getElementById("registerPassword").value;
                const passwordConfirm = document.getElementById("registerPasswordConfirm").value;
                const adresse = document.getElementById("registerAdresse").value;
                const telefonnummer = document.getElementById("registerTelefonnummer").value;
                const bildungstraeger = document.getElementById("registerBildungstraeger").value;

                if (password !== passwordConfirm) {
                    alert("Die Passwörter stimmen nicht überein.");
                    return;
                }

                // Optional: Add more password strength validation here if desired

                try {
                    const response = await fetch("/api/auth/register", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            vorname,
                            nachname,
                            email, 
                            passwort: password,
                            adresse,
                            telefonnummer,
                            bildungstraeger,
                            rolle: "Praktikant" // Default role
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert("Registrierung erfolgreich! Sie können sich jetzt einloggen.");
                        // Optionally, switch to login tab or redirect
                        const loginTab = document.getElementById('login-tab');
                        if (loginTab) {
                            new bootstrap.Tab(loginTab).show();
                        }
                        registerForm.reset(); // Clear the form
                    } else {
                        alert(data.message || "Registrierung fehlgeschlagen.");
                    }
                } catch (error) {
                    console.error("Registrierungsfehler:", error);
                    alert("Registrierung fehlgeschlagen. Bitte versuchen Sie es später erneut.");
                }
            });
        }
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>